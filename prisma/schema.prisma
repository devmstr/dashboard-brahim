generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                 String    @id @default(cuid())
  userId             String
  providerType       String
  providerId         String
  providerAccountId  String
  refreshToken       String?
  accessToken        String?
  accessTokenExpires DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  User               User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  expires      DateTime
  sessionToken String   @unique
  accessToken  String   @unique
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id                                 String                       @id @default(cuid())
  role                               String?
  username                           String?                      @unique
  phone                              String?                      @unique
  email                              String?                      @unique
  passwordHash                       String
  employeeId                         Int                          @unique
  image                              String?
  Accounts                           Account[]
  Sessions                           Session[]
  createdAt                          DateTime                     @default(now())
  updatedAt                          DateTime                     @updatedAt
  Permissions                        Permission[]
  ProcurementRequisitionsCreated     ProcurementRequisition[]     @relation("ProcurementRequisitionCreatedBy")
  ProcurementRequisitionsApproved    ProcurementRequisition[]     @relation("ProcurementRequisitionApprovedBy")
  ProcurementRfqsCreated             ProcurementRfq[]             @relation("ProcurementRfqCreatedBy")
  ProcurementPurchaseOrdersCreated   ProcurementPurchaseOrder[]   @relation("ProcurementPurchaseOrderCreatedBy")
  ProcurementPurchaseOrdersApproved  ProcurementPurchaseOrder[]   @relation("ProcurementPurchaseOrderApprovedBy")
  ProcurementReceiptsCreated         ProcurementReceipt[]         @relation("ProcurementReceiptCreatedBy")
  ProcurementSupplierInvoicesCreated ProcurementSupplierInvoice[] @relation("ProcurementSupplierInvoiceCreatedBy")
  ProcurementContractsCreated        ProcurementContract[]        @relation("ProcurementContractCreatedBy")
  ProcurementAssetsCreated           ProcurementAsset[]           @relation("ProcurementAssetCreatedBy")
}

model VerificationRequest {
  id         String   @id @default(cuid())
  identifier String
  token      String   @unique
  expires    DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([identifier, token])
}

// LOCATION MODELS
model Country {
  id        String     @id @default(cuid())
  code      String     @unique
  name      String
  Provinces Province[]
  Addresses Address[]

  @@map("countries")
}

model Province {
  id        String    @id @default(cuid())
  code      String    @unique
  nameAr    String
  name      String
  countryId String?
  Country   Country?  @relation(fields: [countryId], references: [id], onDelete: Cascade)
  Cities    City[]
  Addresses Address[]

  @@map("provinces")
}

model City {
  id         String    @id @default(cuid())
  zipCode    String    @unique
  nameAr     String
  name       String
  provinceId String
  Province   Province  @relation(fields: [provinceId], references: [id], onDelete: Cascade)
  Addresses  Address[]

  @@map("cities")
}

model Address {
  id         String  @id @default(cuid())
  street     String?
  cityId     String
  provinceId String
  countryId  String

  City     City     @relation(fields: [cityId], references: [id], onDelete: Cascade)
  Province Province @relation(fields: [provinceId], references: [id], onDelete: Cascade)
  Country  Country  @relation(fields: [countryId], references: [id], onDelete: Cascade)
  Client   Client?
  ProcurementSupplier ProcurementSupplier?

  @@map("addresses")
}

// RADIATOR, INVENTORY, COMPONENTS
model Inventory {
  id       String  @id @default(cuid())
  level    Int     @default(0) // Current inventory level
  alertAt  Int     @default(10) // Minimum level to trigger an alert
  maxLevel Int     @default(500) // Maximum level for inventory
  location String?

  Radiators Radiator[]

  @@map("inventories")
}

model InvoiceItem {
  id         String    @id @default(cuid())
  number     Int
  label      String?
  price      Float?
  amount     Float?
  quantity   Int?
  radiatorId String?
  Radiator   Radiator? @relation(fields: [radiatorId], references: [id])
  Invoice    Invoice?  @relation(fields: [invoiceId], references: [id])
  invoiceId  String?

  @@map("InvoiceItem")
}

model Invoice {
  id                  String    @id @default(cuid())
  reference           String    @unique
  date                DateTime? @default(now())
  name                String?
  address             String?
  tradeRegisterNumber String?
  registrationArticle String?
  taxIdNumber         String?
  type                String?
  status              String?
  paymentMode         String?
  purchaseOrder       String?
  deliverySlip        String?
  discountRate        Float?    @default(0)
  discount            Float?    @default(0)
  refundRate          Float?    @default(0)
  refund              Float?    @default(0)
  stampTaxRate        Float?    @default(0)
  stampTax            Float?    @default(0)
  vatRate             Float?    @default(0)
  vat                 Float?    @default(0)
  offerValidity       String?
  guaranteeTime       String?
  deliveryTime        String?
  note                String?
  total               Float?
  subtotal            Float?

  items InvoiceItem[]

  Order   Order?  @relation(fields: [orderId], references: [id], onDelete: SetNull)
  orderId String?

  clientId String?
  Client   Client? @relation(fields: [clientId], references: [id], onDelete: Cascade)

  histories InvoiceHistory[]

  deletedAt DateTime?
  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt

  @@map("invoices")
}

model InvoiceHistory {
  id        String  @id @default(cuid())
  snapshot  Json
  changedBy String?
  reason    String?

  invoiceId String?
  Invoice   Invoice? @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  changedAt DateTime @default(now())

  @@map("invoice_histories")
}

model Price {
  id            String   @id @default(cuid())
  unit          Float    @default(0)
  unitTTC       Float    @default(0) // Including tax
  bulk          Float    @default(0)
  bulkTTC       Float    @default(0) // Including tax
  bulkThreshold Int      @default(100) // Minimum quantity for bulk pricing
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  Radiators Radiator[]

  @@map("prices")
}

model Radiator {
  id                   String        @id @default(cuid())
  partNumber           String?       @unique // is unique manufacturing number 
  category             String?
  dirId                String?
  cooling              String?
  barcode              String?       @unique
  label                String?
  hash                 String?       @unique // Unique hash for the radiator
  status               String? // e.g., "active", "inactive", "draft" , "ar"
  type                 String? // e.g., "collector", "core", "tube"
  production           String? // e.g., "2023-10-01"
  fabrication          String?
  fins                 String?
  pitch                Int?
  tubeType             String?
  rows                 Int?
  tubeDiameter         Int?
  betweenCollectors    Int?
  width                Int?
  position             String?
  tightening           String?
  perforation          String?
  isTinned             Boolean?      @default(false)
  isPainted            Boolean?      @default(true)
  upperCollectorLength Int?
  lowerCollectorLength Int?
  upperCollectorWidth  Int?
  lowerCollectorWidth  Int?
  isActive             Boolean?      @default(false)
  inventoryId          String?
  priceId              String?
  directoryId          String?
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  Inventory            Inventory?    @relation(fields: [inventoryId], references: [id], onDelete: SetNull)
  Price                Price?        @relation(fields: [priceId], references: [id], onDelete: SetNull)
  Directory            Directory?    @relation(fields: [directoryId], references: [id], onDelete: SetNull)
  CarType              Type?
  OrderItems           OrderItem[]
  Components           Component[]
  invoiceId            String?
  InventoryItem        InvoiceItem[]

  @@map("radiators")
}

model Component {
  id         String  @id @default(cuid())
  label      String
  type       String?
  radiatorId String?

  Radiator       Radiator?       @relation(fields: [radiatorId], references: [id], onDelete: Cascade)
  MaterialUsages MaterialUsage[]

  @@map("components")
}

// MATERIAL SYSTEM

model Material {
  id               String          @id @default(cuid())
  reference        String?         @unique
  name             String
  description      String?
  unit             String? // e.g., "kg", "g", "l", "m²", "cm²"
  baseUnit         String? // e.g., "g", "ml", "m²"
  conversionFactor Float? // e.g., 1000 if unit is "kg" and baseUnit is "g"
  unitCost         Float? // cost per base unit
  Usages           MaterialUsage[]

  @@map("materials")
}

model MaterialUsage {
  id          String @id @default(cuid())
  componentId String
  materialId  String
  quantity    Float?

  Component Component @relation(fields: [componentId], references: [id], onDelete: Cascade)
  Material  Material  @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@unique([componentId, materialId])
  @@map("material_usages")
}

// CAR SYSTEM

model Brand {
  id       String   @id @default(cuid())
  name     String   @unique
  Families Family[]

  @@map("car_brands")
}

model Family {
  id      String  @id @default(cuid())
  name    String
  brandId String?

  Brand  Brand?  @relation(fields: [brandId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  Models Model[]

  @@map("car_families")
}

model Model {
  id       String  @id @default(cuid())
  name     String
  familyId String?
  Family   Family? @relation(fields: [familyId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  Types    Type[]

  @@map("car_models")
}

model Type {
  id   String  @id @default(cuid())
  name String
  year String?
  fuel String?

  modelId String?

  Model Model? @relation(fields: [modelId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  Radiator   Radiator?   @relation(fields: [radiatorId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  radiatorId String?     @unique
  OrderItem  OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("car_type")
}

// CLIENTS & ORDERS

model Client {
  id                  String  @id @default(cuid())
  name                String
  phone               String? // TODO: add @unique when the database is ready
  label               String?
  email               String? @unique
  isCompany           Boolean @default(false)
  website             String?
  fiscalNumber        String?
  tradeRegisterNumber String?
  registrationArticle String?
  taxIdNumber         String?
  statisticalIdNumber String?
  approvalNumber      String?

  addressId String?  @unique
  Address   Address? @relation(fields: [addressId], references: [id], onDelete: SetNull)

  Orders    Order[]
  Payments  Payment[] // Added to directly link payments to clients for easier querying
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  Invoice   Invoice[]

  @@map("clients")
}

model Attachment {
  id                           String                      @id @default(cuid())
  url                          String // URL of the uploaded file
  type                         String // MIME type like 'image/jpeg', 'application/pdf', etc.
  name                         String // Original file name
  uniqueName                   String                      @unique // Unique file serial
  Order                        Order?                      @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId                      String?
  createdAt                    DateTime                    @default(now())
  OrderItem                    OrderItem?                  @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  orderItemId                  String? // Made optional to fix the issue @map("orderId")
  ProcurementRequisition       ProcurementRequisition?     @relation("ProcurementRequisitionAttachments", fields: [procurementRequisitionId], references: [id], onDelete: Cascade)
  procurementRequisitionId     String?
  ProcurementRfq               ProcurementRfq?             @relation("ProcurementRfqAttachments", fields: [procurementRfqId], references: [id], onDelete: Cascade)
  procurementRfqId             String?
  ProcurementPurchaseOrder     ProcurementPurchaseOrder?   @relation("ProcurementPurchaseOrderAttachments", fields: [procurementPurchaseOrderId], references: [id], onDelete: Cascade)
  procurementPurchaseOrderId   String?
  ProcurementReceipt           ProcurementReceipt?         @relation("ProcurementReceiptAttachments", fields: [procurementReceiptId], references: [id], onDelete: Cascade)
  procurementReceiptId         String?
  ProcurementSupplierInvoice   ProcurementSupplierInvoice? @relation("ProcurementSupplierInvoiceAttachments", fields: [procurementSupplierInvoiceId], references: [id], onDelete: Cascade)
  procurementSupplierInvoiceId String?
  ProcurementContract          ProcurementContract?        @relation("ProcurementContractAttachments", fields: [procurementContractId], references: [id], onDelete: Cascade)
  procurementContractId        String?
  ProcurementAsset             ProcurementAsset?           @relation("ProcurementAssetAttachments", fields: [procurementAssetId], references: [id], onDelete: Cascade)
  procurementAssetId           String?

  @@map("attachments") // Added map directive for consistency
}

model Order {
  id             String       @id @default(cuid())
  deadline       DateTime     @default(now())
  status         String?
  progress       Int          @default(0)
  OrdersItems    OrderItem[]
  totalItems     Int          @default(0)
  totalAmount    Float? // Added to store the total order value
  deliveredItems Int          @default(0)
  Payment        Payment      @relation(name: "OrderToPayment", fields: [paymentId], references: [id], onDelete: Restrict)
  paymentId      String       @unique
  clientId       String
  Client         Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  Attachments    Attachment[]

  createdAt DateTime  @default(now()) // Added for consistency
  updatedAt DateTime  @updatedAt // Added for consistency
  Invoice   Invoice[]

  @@map("order_batches") // Added map directive for consistency
}

model OrderItem {
  id                   String       @id @default(cuid())
  note                 Json?
  description          Json?
  modification         Json?
  serialNumber         String?
  packaging            String?
  type                 String?
  category             String?
  cooling              String?
  label                String?
  production           String?
  fabrication          String?
  isModified           Boolean?
  status               String? // e.g., "pending", "in_progress", "delivered"
  quantity             Int?
  delivered            Int?
  validatedAt          DateTime?
  canceledAt           DateTime?
  fins                 String?
  pitch                Int?
  tubeType             String?
  rows                 Int?
  tubeDiameter         Int?
  betweenCollectors    Int?
  width                Int?
  position             String?
  tightening           String?
  perforation          String?
  isTinned             Boolean?     @default(false)
  isPainted            Boolean?     @default(true)
  upperCollectorLength Int?
  lowerCollectorLength Int?
  upperCollectorWidth  Int?
  lowerCollectorWidth  Int?
  createdAt            DateTime     @default(now()) // Made consistent (not optional)
  updatedAt            DateTime     @updatedAt // Made consistent (not optional)
  Order                Order?       @relation(fields: [orderId], references: [id], onDelete: SetNull)
  orderId              String?
  Attachments          Attachment[]
  Radiator             Radiator?    @relation(fields: [radiatorId], references: [id])
  radiatorId           String?
  CarType              Type?        @relation(fields: [carTypeId], references: [id])
  carTypeId            String?      @map("typeId")

  @@map("orders")
}

model Payment {
  id                 String               @id @default(cuid())
  amount             Float
  deposit            Float
  remaining          Float
  status             String? // Tracks payment status (e.g., "pending", "partial", "completed")
  mode               String?
  bank               String?
  iban               String?
  depositor          String?
  paymentDate        DateTime? // Precise payment timing for filtering by year
  Order              Order?               @relation(name: "OrderToPayment")
  createdAt          DateTime             @default(now()) // Added for consistency
  updatedAt          DateTime             @updatedAt // Added for consistency
  Client             Client?              @relation(fields: [clientId], references: [id])
  clientId           String?
  PaymentInstallment PaymentInstallment[]

  @@index([clientId])
  @@index([paymentDate])
  @@index([status])
  @@map("payments")
}

model PaymentInstallment {
  id          String   @id @default(cuid())
  paymentId   String
  Payment     Payment  @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  amount      Float
  paymentDate DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("payment_installments")
}

// FILE SYSTEM

model Directory {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  parentId String?
  Parent   Directory?  @relation("FolderParent", fields: [parentId], references: [id], onDelete: SetNull)
  Children Directory[] @relation("FolderParent")

  Files       File[]
  Permissions Permission[]

  Radiators Radiator[]
}

model File {
  id          String  @id @default(cuid())
  name        String
  mimeType    String
  url         String
  size        Int
  description String?
  metadata    Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  directoryId String
  Directory   Directory @relation(fields: [directoryId], references: [id], onDelete: Cascade)

  Tags        Tag[]
  Versions    FileVersion[]
  Permissions Permission[]
}

model FileVersion {
  id        String   @id @default(cuid())
  version   Int
  url       String
  createdAt DateTime @default(now())

  fileId String
  File   File   @relation(fields: [fileId], references: [id], onDelete: Cascade)
}

model Tag {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  Files File[]
}

model Permission {
  id     String  @id @default(cuid())
  access String?
  userId String
  fileId String?
  dirId  String?

  User      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  File      File?      @relation(fields: [fileId], references: [id], onDelete: Cascade)
  Directory Directory? @relation(fields: [dirId], references: [id], onDelete: Cascade)
}

enum ProcurementRequisitionStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  CANCELLED
  ORDERED
}

enum ProcurementRfqStatus {
  DRAFT
  SENT
  RECEIVED
  EVALUATED
  CLOSED
  CANCELLED
}

enum ProcurementRfqQuoteStatus {
  PENDING
  RECEIVED
  SELECTED
  REJECTED
}

enum ProcurementPurchaseOrderStatus {
  DRAFT
  SENT
  CONFIRMED
  PARTIALLY_RECEIVED
  RECEIVED
  CANCELLED
  CLOSED
}

enum ProcurementReceiptStatus {
  DRAFT
  PARTIALLY_RECEIVED
  RECEIVED
  CANCELLED
}

enum ProcurementSupplierInvoiceStatus {
  DRAFT
  RECEIVED
  APPROVED
  PAID
  CANCELLED
}

enum ProcurementContractStatus {
  DRAFT
  ACTIVE
  EXPIRED
  TERMINATED
}

enum ProcurementAssetStatus {
  PLANNED
  ACTIVE
  DISPOSED
}

model ProcurementSupplier {
  id                  String  @id @default(cuid())
  name                String
  code                String? @unique
  category            String?
  contactName         String?
  email               String?
  phone               String?
  website             String?
  fiscalNumber        String?
  taxIdNumber         String?
  registrationArticle String?
  statisticalIdNumber String?
  tradeRegisterNumber String?
  approvalNumber      String?

  addressId String?  @unique
  Address   Address? @relation(fields: [addressId], references: [id], onDelete: SetNull)

  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  RfqQuotes      ProcurementRfqVendorQuote[]
  PurchaseOrders ProcurementPurchaseOrder[]
  Invoices       ProcurementSupplierInvoice[]
  Assets         ProcurementAsset[]

  @@map("procurement_suppliers")
}

model ProcurementItem {
  id          String   @id @default(cuid())
  name        String
  sku         String?  @unique
  category    String?
  description String?
  unit        String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  RequisitionItems   ProcurementRequisitionItem[]
  RfqLines           ProcurementRfqLine[]
  PurchaseOrderItems ProcurementPurchaseOrderItem[]
  ReceiptItems       ProcurementReceiptItem[]
  AssetItems         ProcurementAssetItem[]

  @@map("procurement_items")
}

model ProcurementService {
  id        String   @id @default(cuid())
  name      String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  Requisitions   ProcurementRequisition[]
  Rfqs           ProcurementRfq[]
  PurchaseOrders ProcurementPurchaseOrder[]
  Receipts       ProcurementReceipt[]
  Invoices       ProcurementSupplierInvoice[]
  Contracts      ProcurementContract[]
  Assets         ProcurementAsset[]

  @@map("procurement_services")
}

model ProcurementRequisition {
  id        String                       @id @default(cuid())
  reference String                       @unique
  title     String?
  status    ProcurementRequisitionStatus @default(DRAFT)
  neededBy  DateTime?
  notes     String?
  createdAt DateTime                     @default(now())
  updatedAt DateTime                     @updatedAt

  createdById  String
  approvedById String?
  serviceId    String?

  CreatedBy  User                @relation("ProcurementRequisitionCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  ApprovedBy User?               @relation("ProcurementRequisitionApprovedBy", fields: [approvedById], references: [id], onDelete: SetNull)
  Service    ProcurementService? @relation(fields: [serviceId], references: [id], onDelete: SetNull)

  Items          ProcurementRequisitionItem[]
  Rfqs           ProcurementRfq[]
  PurchaseOrders ProcurementPurchaseOrder[]
  Attachments    Attachment[]                 @relation("ProcurementRequisitionAttachments")

  @@map("procurement_requisitions")
}

model ProcurementRequisitionItem {
  id                String   @id @default(cuid())
  requisitionId     String
  itemId            String?
  description       String?
  quantity          Float?
  unit              String?
  estimatedUnitCost Float?
  currency          String?  @default("DZD")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  Requisition ProcurementRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  Item        ProcurementItem?       @relation(fields: [itemId], references: [id], onDelete: SetNull)

  @@map("procurement_requisition_items")
}

model ProcurementRfq {
  id        String               @id @default(cuid())
  reference String               @unique
  status    ProcurementRfqStatus @default(DRAFT)
  neededBy  DateTime?
  notes     String?
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt

  requisitionId String?
  createdById   String
  serviceId     String?

  Requisition ProcurementRequisition? @relation(fields: [requisitionId], references: [id], onDelete: SetNull)
  CreatedBy   User                    @relation("ProcurementRfqCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  Service     ProcurementService?     @relation(fields: [serviceId], references: [id], onDelete: SetNull)

  Lines          ProcurementRfqLine[]
  VendorQuotes   ProcurementRfqVendorQuote[]
  PurchaseOrders ProcurementPurchaseOrder[]
  Attachments    Attachment[]                @relation("ProcurementRfqAttachments")

  @@map("procurement_rfqs")
}

model ProcurementRfqLine {
  id          String   @id @default(cuid())
  rfqId       String
  itemId      String?
  description String?
  quantity    Float?
  unit        String?
  estimatedUnitCost Float?
  currency          String?  @default("DZD")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  Rfq  ProcurementRfq   @relation(fields: [rfqId], references: [id], onDelete: Cascade)
  Item ProcurementItem? @relation(fields: [itemId], references: [id], onDelete: SetNull)

  QuoteLines ProcurementRfqVendorQuoteLine[]

  @@map("procurement_rfq_lines")
}

model ProcurementRfqVendorQuote {
  id         String                    @id @default(cuid())
  rfqId      String
  supplierId String
  status     ProcurementRfqQuoteStatus @default(PENDING)
  currency   String?                   @default("DZD")
  subtotal   Float?
  taxes      Float?
  total      Float?
  validUntil DateTime?
  notes      String?
  createdAt  DateTime                  @default(now())
  updatedAt  DateTime                  @updatedAt

  Rfq      ProcurementRfq      @relation(fields: [rfqId], references: [id], onDelete: Cascade)
  Supplier ProcurementSupplier @relation(fields: [supplierId], references: [id], onDelete: Restrict)

  Lines ProcurementRfqVendorQuoteLine[]

  @@map("procurement_rfq_vendor_quotes")
}

model ProcurementRfqVendorQuoteLine {
  id           String   @id @default(cuid())
  quoteId      String
  rfqLineId    String
  quantity     Float?
  unitPrice    Float?
  total        Float?
  leadTimeDays Int?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  Quote   ProcurementRfqVendorQuote @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  RfqLine ProcurementRfqLine        @relation(fields: [rfqLineId], references: [id], onDelete: Cascade)

  @@map("procurement_rfq_vendor_quote_lines")
}

model ProcurementPurchaseOrder {
  id           String                         @id @default(cuid())
  reference    String                         @unique
  status       ProcurementPurchaseOrderStatus @default(DRAFT)
  vendor       String?
  contactName  String?
  contactEmail String?
  phone        String?
  itemsCount   Int?
  currency     String?                        @default("DZD")
  subtotal     Float?
  taxes        Float?
  total        Float?
  expectedDate DateTime?
  deliveredAt  DateTime?
  paymentTerms String?
  notes        String?
  createdAt    DateTime                       @default(now())
  updatedAt    DateTime                       @updatedAt

  supplierId    String?
  requisitionId String?
  rfqId         String?
  createdById   String?
  approvedById  String?
  serviceId     String?

  Supplier    ProcurementSupplier?    @relation(fields: [supplierId], references: [id], onDelete: SetNull)
  Requisition ProcurementRequisition? @relation(fields: [requisitionId], references: [id], onDelete: SetNull)
  Rfq         ProcurementRfq?         @relation(fields: [rfqId], references: [id], onDelete: SetNull)
  CreatedBy   User?                   @relation("ProcurementPurchaseOrderCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  ApprovedBy  User?                   @relation("ProcurementPurchaseOrderApprovedBy", fields: [approvedById], references: [id], onDelete: SetNull)
  Service     ProcurementService?     @relation(fields: [serviceId], references: [id], onDelete: SetNull)

  Items       ProcurementPurchaseOrderItem[]
  Receipts    ProcurementReceipt[]
  Invoices    ProcurementSupplierInvoice[]
  Assets      ProcurementAsset[]
  Attachments Attachment[]                   @relation("ProcurementPurchaseOrderAttachments")

  @@map("procurements")
}

model ProcurementPurchaseOrderItem {
  id               String   @id @default(cuid())
  purchaseOrderId  String
  itemId           String?
  description      String?
  quantity         Float?
  unit             String?
  unitPrice        Float?
  total            Float?
  receivedQuantity Float?   @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  PurchaseOrder ProcurementPurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  Item          ProcurementItem?         @relation(fields: [itemId], references: [id], onDelete: SetNull)

  ReceiptItems ProcurementReceiptItem[]

  @@map("procurement_purchase_order_items")
}

model ProcurementReceipt {
  id         String                   @id @default(cuid())
  reference  String                   @unique
  status     ProcurementReceiptStatus @default(DRAFT)
  receivedAt DateTime?
  notes      String?
  createdAt  DateTime                 @default(now())
  updatedAt  DateTime                 @updatedAt

  purchaseOrderId String
  createdById     String
  serviceId       String?

  PurchaseOrder ProcurementPurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  CreatedBy     User                     @relation("ProcurementReceiptCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  Service       ProcurementService?      @relation(fields: [serviceId], references: [id], onDelete: SetNull)

  Items       ProcurementReceiptItem[]
  Invoices    ProcurementSupplierInvoice[]
  Attachments Attachment[]                 @relation("ProcurementReceiptAttachments")

  @@map("procurement_receipts")
}

model ProcurementReceiptItem {
  id                  String   @id @default(cuid())
  receiptId           String
  purchaseOrderItemId String?
  itemId              String?
  quantityReceived    Float?
  condition           String?
  notes               String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  Receipt           ProcurementReceipt            @relation(fields: [receiptId], references: [id], onDelete: Cascade)
  PurchaseOrderItem ProcurementPurchaseOrderItem? @relation(fields: [purchaseOrderItemId], references: [id], onDelete: SetNull)
  Item              ProcurementItem?              @relation(fields: [itemId], references: [id], onDelete: SetNull)

  @@map("procurement_receipt_items")
}

model ProcurementSupplierInvoice {
  id          String                           @id @default(cuid())
  reference   String                           @unique
  status      ProcurementSupplierInvoiceStatus @default(DRAFT)
  invoiceDate DateTime?
  dueDate     DateTime?
  paidAt      DateTime?
  currency    String?                          @default("DZD")
  subtotal    Float?
  taxes       Float?
  total       Float?
  notes       String?
  createdAt   DateTime                         @default(now())
  updatedAt   DateTime                         @updatedAt

  supplierId      String
  purchaseOrderId String?
  receiptId       String?
  createdById     String
  serviceId       String?

  Supplier      ProcurementSupplier       @relation(fields: [supplierId], references: [id], onDelete: Restrict)
  PurchaseOrder ProcurementPurchaseOrder? @relation(fields: [purchaseOrderId], references: [id], onDelete: SetNull)
  Receipt       ProcurementReceipt?       @relation(fields: [receiptId], references: [id], onDelete: SetNull)
  CreatedBy     User                      @relation("ProcurementSupplierInvoiceCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  Service       ProcurementService?       @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  Attachments   Attachment[]              @relation("ProcurementSupplierInvoiceAttachments")

  @@map("procurement_supplier_invoices")
}

model ProcurementContract {
  id        String                    @id @default(cuid())
  reference String                    @unique
  title     String?
  category  String?
  status    ProcurementContractStatus @default(DRAFT)
  startDate DateTime
  endDate   DateTime?
  value     Float?
  currency  String?                   @default("DZD")
  notes     String?
  createdAt DateTime                  @default(now())
  updatedAt DateTime                  @updatedAt

  createdById String
  serviceId   String?

  CreatedBy   User                @relation("ProcurementContractCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  Service     ProcurementService? @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  Attachments Attachment[]        @relation("ProcurementContractAttachments")

  @@map("procurement_contracts")
}

model ProcurementAsset {
  id              String                 @id @default(cuid())
  reference       String                 @unique
  name            String
  status          ProcurementAssetStatus @default(PLANNED)
  acquisitionDate DateTime?
  value           Float?
  currency        String?                @default("DZD")
  notes           String?
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt

  supplierId      String?
  purchaseOrderId String?
  createdById     String
  serviceId       String?

  Supplier      ProcurementSupplier?      @relation(fields: [supplierId], references: [id], onDelete: SetNull)
  PurchaseOrder ProcurementPurchaseOrder? @relation(fields: [purchaseOrderId], references: [id], onDelete: SetNull)
  CreatedBy     User                      @relation("ProcurementAssetCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  Service       ProcurementService?       @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  Attachments   Attachment[]              @relation("ProcurementAssetAttachments")
  Items         ProcurementAssetItem[]

  @@map("procurement_assets")
}

model ProcurementAssetItem {
  id                String   @id @default(cuid())
  assetId           String
  itemId            String?
  description       String?
  quantity          Float?
  unit              String?
  estimatedUnitCost Float?
  currency          String?  @default("DZD")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  Asset ProcurementAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)
  Item  ProcurementItem? @relation(fields: [itemId], references: [id], onDelete: SetNull)

  @@map("procurement_asset_items")
}
